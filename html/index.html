<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>x186k broadcast/watch page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>
</head>

<body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">

            <div class="navbar-item">
                <div class="buttons">
                    <a class="button is-primary">
                        <strong>Sign up</strong>
                    </a>
                    <a class="button is-light">
                        Log in
                    </a>
                </div>
            </div>




        </div>
    </nav>
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-half">
                    <div class="field is-grouped is-centered p-4">
                        <p class="control">
                            <button class="button is-link" onclick="transmit()">Start Transmission</button>
                        </p>
                        <p class="control">
                            <button class=" button is-link" onclick="receive()">Start Receive</button>
                        </p>
                    </div>
                </div>
                <div class=" column">
                    <figure class="image is-16by9">
                        <video id="video1" autoplay muted class="has-ratio" width="1280" height="720" frameborder="0"
                            poster="https://x186k.org/x186k.png" allowfullscreen>
                        </video>
                    </figure>
                </div>
            </div>
        </div>
    </section>


    <section class="section">
        <div class="container">

        </div>
    </section>
    <script>
        //@ts-check

        let suburl = location.origin + '/sub'        // output from sfu
        let puburl = location.origin + '/pub'          // input to sfu


        function longRandomString() {
            var buffer = new Uint8Array(10)
            window.crypto.getRandomValues(buffer)
            return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
        }



        async function transmit() {
            console.log("--transmit")


            try {
                const gumopts = { video: { width: 1280, height: 720 }, audio: true }
                const stream = await navigator.mediaDevices.getUserMedia(gumopts)


                document.getElementById('video1').srcObject = stream
                //   var t0 = performance.now()
                //console.debug("delay of " + (performance.now() - t0) + "ms")
                let pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] })
                pc.oniceconnectionstatechange = e => console.debug(pc.iceConnectionState)
                //pc.onicecandidate = event => { console.debug('ignore ice candidate') }

                let simulcast = true
                if (simulcast) {
                    pc.addTransceiver(stream.getVideoTracks()[0], {
                        //cam sendrecv will not fix rids Ontrack bug
                        direction: 'sendonly',
                        streams: [stream],
                        sendEncodings: [
                            // for firefox order matters... first high resolution, then scaled resolutions...
                            {
                                rid: 'a'
                            },
                            {
                                rid: 'b',
                                scaleResolutionDownBy: 2.0
                            },
                            {
                                rid: 'c',
                                scaleResolutionDownBy: 4.0
                            },
                        ],
                    });
                    //the original added three tx's here for the return streams
                    // for the sample
                    // they did not nave sendonly, but could have I believe
                    // leaving this transciver in, even though
                    // it is not needed fixes the 
                    // OnTrack callback issue
                    //pc.addTransceiver('video', { 'direction': 'sendonly' })
                    // pc.addTransceiver('video', {'direction': 'sendonly'})
                    // pc.addTransceiver('video', {'direction': 'sendonly'})
                } else {
                    pc.addTransceiver(stream.getVideoTracks()[0], { 'direction': 'sendonly' })
                }
                pc.addTransceiver(stream.getAudioTracks()[0], { 'direction': 'sendonly' })

                let desc = await pc.createOffer()
                await pc.setLocalDescription(desc)


                console.debug('sending N line offer:', desc.sdp.split(/\r\n|\r|\n/).length)
                let fetchopt =
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/sdp', },
                    body: desc.sdp
                }
                let resp = await fetch(puburl, fetchopt)
                let resptext = await resp.text()
                if (resp.status != 202) {
                    console.error('sfu http error', resp.status, resptext)
                    pc.close()
                    return
                }
                console.debug('got N line answer:', resptext.split(/\r\n|\r|\n/).length)
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: resptext }))


            } catch (error) {
                console.error('pub error', error)
            }
        }


        async function receive() {
            console.log("--receive")



            try {
                const txid = longRandomString()
                const url = suburl + '?step=1&txid=' + txid
                const fetchopt1 =
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/sdp', },
                    body: ''
                }
                console.debug('before fetch1')
                const resp = await fetch(url, fetchopt1)
                const resptext = await resp.text()
                console.debug('fetch1 http status code', resp.status)
                if (resp.status != 202) {
                    console.error('sfu http error', resp.status, resptext)
                    try { pc.close() } catch (error) { }
                    return
                }


                let pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] })
                pc.oniceconnectionstatechange = e => console.debug(pc.iceConnectionState)
                //pc.onicecandidate = event => { console.debug('ignore ice candidate') }
                // pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: posttext }))



                pc.ontrack = function (event) {
                    let z = event.streams[0]
                    console.debug('on track fired naudio', z.getAudioTracks().length)
                    console.debug('on track fired nvideo', z.getVideoTracks().length)
                    var el = document.getElementById('video1')
                    el.srcObject = event.streams[0]
                    el.autoplay = true
                    el.controls = true
                    return false
                }

                console.debug('got N line offer:', resptext.split(/\r\n|\r|\n/).length)

                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: resptext }))
                console.debug('n senders in getsenders()', pc.getSenders())
                //// pc.addTransceiver('audio', { 'direction': 'recvonly' })
                // pc.addTransceiver('video', { 'direction': 'recvonly' })
                console.debug('n senders in getsenders()', pc.getSenders())
                let init = await pc.createAnswer()
                await pc.setLocalDescription(init)


                console.debug('will post N line answer:', pc.localDescription.sdp.split(/\r\n|\r|\n/).length)

                const url2 = suburl + '?step=2&txid=' + txid
                const fetchopt2 =
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/sdp', },
                    body: pc.localDescription.sdp
                }
                console.debug('before fetch2')
                const resp2 = await fetch(url2, fetchopt2)
                console.debug('fetch2 http status code', resp2.status)

            } catch (error) {
                console.error('receive error', error)
            }
        }

    </script>
</body>

</html>